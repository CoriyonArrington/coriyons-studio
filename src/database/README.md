# 🗃️ `database/` — Supabase Schema & Seed Files

This folder stores database-related assets for Coriyon’s Studio, including:

- 📄 **Core Schema Definition Scripts**: A set of ordered SQL files (e.g., `00_types_and_functions.sql`, `01_tables_core.sql`, etc.) that collectively define the complete database schema—including tables, types, functions, triggers, RLS policies, indexes, and comments. These files are your source of truth for creating or updating the database structure.
- 🌱 **Seeding Scripts**: SQL scripts located in the `seed/` subfolder, used to populate development or test environments with sample data.
- 🔍 **Schema Dumps**: (Optional) `.sql` files in the `schemas/` subfolder, generated by tools like `./scripts/generate-database-schema.sh`, which can be used for tracking the live Supabase structure or for backups.
- 🚧 **Migrations**: This folder may also contain migrations if adopting Supabase’s built-in migration workflow in the future.

Maintaining these files ensures you can version-control backend changes and restore or set up environments accurately and consistently.

---

## ✅ Who This Is For

- Backend developers managing Supabase tables, RLS policies, functions, and views.
- QA/Test engineers setting up or resetting staging or local development environments.
- AI agents or scripts that need to generate TypeScript types from the database schema.
- Anyone needing to understand the database structure and its evolution.

---

## 📂 Folder Structure

| File / Subfolder                  | Purpose                                                                                                |
| --------------------------------- | ------------------------------------------------------------------------------------------------------ |
| `00_types_and_functions.sql`      | Defines custom SQL types (ENUMs) and helper functions (e.g., `handle_updated_at`).                     |
| `01_tables_core.sql`              | Contains `CREATE TABLE` statements for all tables, defining columns, primary keys, and foreign keys.   |
| `02_triggers.sql`                 | Contains `CREATE TRIGGER` statements, primarily for `updated_at` timestamp automation.                 |
| `03_rls_policies.sql`             | Contains `ALTER TABLE … ENABLE ROW LEVEL SECURITY` and all `CREATE POLICY` statements.                 |
| `04_indexes.sql`                  | Contains `CREATE INDEX` statements for foreign keys and other performance-critical columns.           |
| `05_comments.sql`                 | Contains `COMMENT ON TABLE` and `COMMENT ON COLUMN` statements for schema documentation.                |
| `schemas/`                        | (Optional) Stores `.sql` exports (dumps) of the live DB schema (structure only, no data) for reference. |
| `seed/`                           | Contains SQL insert scripts for populating the database with development/test seed data.               |

---

## ⚙️ Key Scripts & Operations

**Applying the Schema**  
To set up or update the database schema, execute the numbered SQL files in this `database/` directory root in their numerical order (00 through 05).  
Example using `psql` (ensure your Supabase connection variables like `$DB_HOST`, `$DB_USER`, and `$DB_NAME` are set):

```bash
psql -h $DB_HOST -U $DB_USER -d $DB_NAME -f 00_types_and_functions.sql
psql -h $DB_HOST -U $DB_USER -d $DB_NAME -f 01_tables_core.sql
# …and so on for all numbered SQL files.
```

*(Alternatively, concatenate them into a single script for execution if preferred—just make sure to maintain the order.)*

**Other Useful Scripts (as per your project structure):**

```bash
# Dump the current Supabase schema to database/schemas/schema.sql (for reference/backup)
./scripts/generate-database-schema.sh

# Regenerate TypeScript types from Supabase schema
./scripts/generate-supabase-types.sh
```

> ⚠️ All schema definition scripts (`00_*.sql` through `05_*.sql`) should be version-controlled as the source of truth. Schema dumps in `schemas/` are for reference or backup only.

---

## 🔒 Security & Best Practices

- Enforce Row-Level Security (RLS) policies rigorously. These are defined in `03_rls_policies.sql`.
- Never commit real user or client data. Use anonymized or fabricated data for any seed scripts in the `seed/` folder.
- Regularly review seed data scripts to ensure no sensitive information is accidentally included.
- Ensure foreign key columns are indexed for performance (as defined in `04_indexes.sql`).

---

## 📌 Related Documentation

- **Database Schemas Overview** → `src/database/overview-database-schemas.md`  
  (Detailed markdown document describing each table—confirm that this path is correct in your project.)
- **Generated Types** → `types/supabase.ts`  
  (Generated by `./scripts/generate-supabase-types.sh`.)
- **Schema Drift Check Script** → `scripts/check-schema-drift.sh`  
  (If you use this, ensure it can compare against your DDL files or a clean dump.)

Use the `database/` folder to keep your backend schema versioned, secure, well-documented, and easy to restore or replicate ✅
